Performance improvements; code refactor; some cleanup.
